rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Users can only read their own profile, but any authenticated user can create one (for sign-up)
    match /users/{userId} {
      allow read, update: if isAuthenticated() && request.auth.uid == userId;
      allow create: if isAuthenticated();
    }

    // Users can only read and write their own state document
    match /userStates/{userId} {
      // Allow any authenticated user to READ any user state for real-time dashboards
      allow read: if isAuthenticated();
      // Allow only the user to WRITE their own state
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Any authenticated user can write to the activity log (for their own activities)
    match /activity/{logId} {
      allow read, write: if isAuthenticated();
    }
    
    // Any authenticated user can write to the timesheet (for their own actions)
    match /timesheet/{entryId} {
       allow read, write: if isAuthenticated();
    }
    
    // Overbreaks are for alerts. Any authenticated user can read them for dashboard alerts.
    // Writing should be handled by secure server-side logic (e.g., in useTimeTracker hook)
    match /overbreaks/{overbreakId} {
        allow read, write: if isAuthenticated();
    }
  }
}
