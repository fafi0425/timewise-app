rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      // Admins can read/write all user profiles.
      // Users can read their own profile.
      allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Administrator' || request.auth.uid == userId;
      allow write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Administrator';
      allow create: if request.auth.uid != null;
    }

    match /activity/{activityId} {
        // Admins can read all activity.
        // Authenticated users can read all activity (for on-break list).
        allow read: if request.auth != null;
        // Users can only create activity for themselves.
        allow create: if request.auth.uid == request.resource.data.uid;
    }
    
    match /timesheet/{timesheetId} {
        // Admins can read all timesheet entries.
        // Users can only read their own timesheet entries.
        allow read: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Administrator' || request.auth.uid == resource.data.uid;
        // Users can only create timesheet entries for themselves.
        allow create: if request.auth.uid == request.resource.data.uid;
    }

    match /userStates/{userId} {
        // Admins can read all user states.
        // Authenticated users can read all states (for on-break/on-shift lists).
        allow read: if request.auth != null;
        // Users can only update their own state.
        allow write: if request.auth.uid == userId;
    }
  }
}
